!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports.floom=i():t.floom=i()}(window,(function(){return function(t){var i={};function e(n){if(i[n])return i[n].exports;var r=i[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,e),r.l=!0,r.exports}return e.m=t,e.c=i,e.d=function(t,i,n){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:n})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(e.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var r in t)e.d(n,r,function(i){return t[i]}.bind(null,r));return n},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=3)}([function(t,i){var e=/^(?:0|[1-9]\d*)$/;function n(t,i){for(var e=-1,n=t?t.length:0;++e<n&&!1!==i(t[e],e,t););return t}var r,o,s=Object.prototype,a=s.hasOwnProperty,c=s.toString,u=s.propertyIsEnumerable,l=(r=Object.keys,o=Object,function(t){return r(o(t))});function h(t,i){var e=v(t)||function(t){return function(t){return function(t){return!!t&&"object"==typeof t}(t)&&m(t)}(t)&&a.call(t,"callee")&&(!u.call(t,"callee")||"[object Arguments]"==c.call(t))}(t)?function(t,i){for(var e=-1,n=Array(t);++e<t;)n[e]=i(e);return n}(t.length,String):[],n=e.length,r=!!n;for(var o in t)!i&&!a.call(t,o)||r&&("length"==o||x(o,n))||e.push(o);return e}var y,p,f=(y=function(t,i){return t&&d(t,i,w)},function(t,i){if(null==t)return t;if(!m(t))return y(t,i);for(var e=t.length,n=p?e:-1,r=Object(t);(p?n--:++n<e)&&!1!==i(r[n],n,r););return t}),d=function(t){return function(i,e,n){for(var r=-1,o=Object(i),s=n(i),a=s.length;a--;){var c=s[t?a:++r];if(!1===e(o[c],c,o))break}return i}}();function g(t){if(e=(i=t)&&i.constructor,n="function"==typeof e&&e.prototype||s,i!==n)return l(t);var i,e,n,r=[];for(var o in Object(t))a.call(t,o)&&"constructor"!=o&&r.push(o);return r}function x(t,i){return!!(i=null==i?9007199254740991:i)&&("number"==typeof t||e.test(t))&&t>-1&&t%1==0&&t<i}var v=Array.isArray;function m(t){return null!=t&&function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991}(t.length)&&!function(t){var i=function(t){var i=typeof t;return!!t&&("object"==i||"function"==i)}(t)?c.call(t):"";return"[object Function]"==i||"[object GeneratorFunction]"==i}(t)}function w(t){return m(t)?h(t):g(t)}function M(t){return t}t.exports=function(t,i){return(v(t)?n:f)(t,"function"==typeof i?i:M)}},function(t,i){t.exports=function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}},function(t,i){function e(t,i){for(var e=0;e<i.length;e++){var n=i[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}t.exports=function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}},function(t,i,e){"use strict";e.r(i);var n=e(1),r=e.n(n),o=e(2),s=e.n(o),a=function(){function t(i){r()(this,t),this.setColor(t.getColor(i)),this.materialIndex=i,this.particleMass=1,this.restDensity=1,this.stiffness=1,this.bulkViscosity=1,this.surfaceTension=.2,this.elasticity=.05,this.maxDeformation=0,this.meltRate=0,this.shearViscosity=0,this.viscosity=.02,this.damping=.1,this.wallFriction=0,this.wallAttraction=1,this.smoothing=1,this.isElastic=!1,this.springK=.3,this.yieldPoint=0,this.yieldRate=1}return s()(t,[{key:"setColor",value:function(t){return this.color=t,this}},{key:"setParticleMass",value:function(t){return this.particleMass=t,this}},{key:"setRestDensity",value:function(t){return this.restDensity=t,this}},{key:"setStiffness",value:function(t){return this.stiffness=t,this}},{key:"setBulkViscosityfunction",value:function(t){return this.bulkViscosity=t,this}},{key:"setSurfaceTensionfunction",value:function(t){return this.surfaceTension=t,this}},{key:"setElasticity",value:function(t){return this.elasticity=t,this}},{key:"setMaxDeformation",value:function(t){return this.maxDeformation=t,this}},{key:"setMeltRate",value:function(t){return this.meltRate=t,this}},{key:"setShearViscosity",value:function(t){return this.shearViscosity=t,this}},{key:"setViscosity",value:function(t){return this.viscosity=t,this}},{key:"setDamping",value:function(t){return this.damping=t,this}},{key:"setWallFrictiong",value:function(t){return this.wallFriction=t,this}},{key:"setWallAttraction",value:function(t){return this.wallAttraction=t,this}},{key:"setSmoothing",value:function(t){return this.smoothing=t,this}},{key:"setIsElastic",value:function(t){return this.isElastic=t,this}},{key:"setSpringK",value:function(t){return this.springK=t,this}},{key:"setYieldPoint",value:function(t){return this.yieldPoint=t,this}},{key:"setYieldRate",value:function(t){return this.yieldRate=t,this}}],[{key:"getColor",value:function(t){var i=["#1f78b4","#e31a1c","#fdbf6f","#b2df8a","#fb9a99","#ff7f00","#33a02c","#cab2d6","#6a3d9a","#ffff99","#b15928"];return i[t%i.length]}}]),t}(),c=function(t,i){if(void 0===i)throw Error("initialize Vector2 with less than 2 parameter");this.x=t,this.y=i};c.Zero=new c(0,0),c.One=new c(1,1),c.XAxis=new c(1,0),c.YAxis=new c(0,1),c.fromAngle=function(t){return new c(Math.cos(t),Math.sin(t))},c.prototype.copy=function(){return new c(this.x,this.y)},c.prototype.set=function(t){return this.x=t.x,this.y=t.y,this},c.prototype.setXY=function(t,i){return this.x=t,this.y=i,this},c.prototype.clear=function(){this.x=0,this.y=0},c.prototype.floor=function(){return new c(Math.floor(this.x),Math.floor(this.y))},c.prototype.floorSelf=function(){this.x=Math.floor(this.x),this.y=Math.floor(this.y)},c.prototype.frac=function(){return new c(this.x-Math.floor(this.x),this.y-Math.floor(this.y))},c.prototype.fracSelf=function(){this.x-=Math.floor(this.x),this.y-=Math.floor(this.y)},c.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},c.prototype.notEquals=function(t){return this.x!=t.x||this.y!=t.y},c.prototype.add=function(t){return new c(this.x+t.x,this.y+t.y)},c.prototype.addSelf=function(t){return this.x+=t.x,this.y+=t.y,this},c.prototype.weightedAddSelf=function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this},c.prototype.sub=function(t){return new c(this.x-t.x,this.y-t.y)},c.prototype.subSelf=function(t){return this.x-=t.x,this.y-=t.y,this},c.prototype.mulFloat=function(t){return new c(this.x*t,this.y*t)},c.prototype.mulFloatSelf=function(t){return this.x*=t,this.y*=t,this},c.prototype.divFloat=function(t){var i=1/t;return new c(this.x*i,this.y*i)},c.prototype.divFloatSelf=function(t){return this.x/=t,this.y/=t,this},c.prototype.mulVector=function(t){return new c(this.x*t.x,this.y*t.y)},c.prototype.mulVectorSelf=function(t){return this.x*=t.x,this.y*=t.y,this},c.prototype.divVector=function(t){return new c(this.x/t.x,this.y/t.y)},c.prototype.divVectorSelf=function(t){return this.x/=t.x,this.y/=t.y,this},c.prototype.positive=function(){return this},c.prototype.negative=function(){return new c(-this.x,-this.y)},c.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},c.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},c.prototype.distance=function(t){var i=this.x-t.x,e=this.y-t.y;return Math.sqrt(i*i+e*e)},c.prototype.distanceSquared=function(t){var i=this.x-t.x,e=this.y-t.y;return i*i+e*e},c.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t>1e-8){var i=1/t;this.x*=i,this.y*=i}return t},c.prototype.normalizedCopy=function(){var t=this.copy();return t.normalize(),t},c.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y},c.prototype.getPerpendicular=function(){return this.getRightPerpendicular()},c.prototype.getLeftPerpendicular=function(){var t=this.y,i=-1*this.x;return new c(t,i)},c.prototype.getRightPerpendicular=function(){var t=-1*this.y,i=this.x;return new c(t,i)},c.prototype.makePerpendicular=function(){var t=this.x;this.x=-this.y,this.y=t},c.prototype.crossProduct=function(t){return this.x*t.y+this.y*t.x},c.prototype.lerp=function(t,i){return this.add(t.sub(this).mulFloat(i))},c.prototype.lerpSelf=function(t,i){return this.weightedAddSelf(t.sub(this),i)},c.prototype.slerp=function(t,i){return this.add(t.sub(this).mulFloat(.5+.5*Math.sin(3.141592654*i-1.570796)))},c.prototype.rotate=function(t){var i=Math.cos(t),e=Math.sin(t);return new c(i*this.x-e*this.y,e*this.x+i*this.y)},c.prototype.rotateSelf=function(t){var i=Math.cos(t),e=Math.sin(t),n=i*this.x-e*this.y;this.y=e*this.x+i*this.y,this.x=n},c.prototype.getDirectedAngle=function(t){return 180*Math.atan2(this.crossProduct(t),this.dotProduct(t))/Math.PI},c.prototype.reflectOnNormal=function(t){return this.sub(t.mulFloat(this.dotProduct(t)).mulFloat(2))},c.prototype.toCartesian=function(){return new c(this.x*Math.cos(this.y),this.x*Math.sin(this.y))},c.prototype.toPolar=function(){return new c(Math.sqrt(this.x*this.x+this.y*this.y),Math.atan2(this.y,this.x))},c.prototype.signum=function(){return new c(this.x.sign(),this.y.sign())},c.prototype.absolute=function(){return new c(Math.abs(this.x),Math.abs(this.y))},c.prototype.toJson=function(){return{x:this.x,y:this.y}},c.fromJson=function(t){return new c(t.x,t.y)},c.fromMatrix=function(t){try{return new c(t.data[0][0],t.data[0][0])}catch(t){throw new Error("wrong matrix format")}};var u=c,l=!0,h=(new TypeError("Error, wrong object! The object has to be a matrix or a number."),new TypeError("Error, wrong object! The object has to be a matrix.")),y=(new TypeError("Error, wrong object! The object has to be a function."),new RangeError("Error, wrong dimensions! Amount of columns of A have to be equal to the amount of rows of B."),function(){function t(i,e,n){var o=this;r()(this,t),i=Number.isInteger(i)?i:3,e=Number.isInteger(e)?e:3,n=Number.isInteger(n)?n:0,this.cols=e,this.rows=i,this.data=new Array(this.rows).fill(0).map((function(t){return new Array(o.cols).fill(n)}))}return s()(t,[{key:"show",value:function(){console.table(this.data)}},{key:"random",value:function(i,e){this.data=this.data.map((function(n){return n.map((function(n){return t.randomInt(i||0,e||1)}))}))}},{key:"toArray",value:function(){new Array(this.rows);return this.data.splice(0)}},{key:"toArray_flat",value:function(){var t=[];return this.data.forEach((function(i){return i.forEach((function(i){return t.push(i)}))})),t}},{key:"toString",value:function(){return this.data.toString()}},{key:"serialize",value:function(){return JSON.stringify(this)}},{key:"reduce",value:function(){if(Array.flatten)return this.data.flatten().reduce();var t=0;return this.data.forEach((function(i){i.forEach((function(i){t+=i}))})),t}},{key:"map",value:function(i){if("function"!=typeof i)return console.log(t.wrong_type_error_message3()),null;this.data=this.data.map((function(t){return t.map((function(t){return i(t)}))}))}},{key:"copy",value:function(){var i=new t(this.rows,this.cols);return i.data=this.data.slice(0),i}},{key:"unit",value:function(){this.data=this.data.map((function(t,i){return t.map((function(t,e){return e===i?1:0}))}))}},{key:"diagonal",value:function(i,e){if(null!=i&&"number"!=typeof i||null!=e&&"number"!=typeof e)return console.log(t.wrong_type_error_message()),null;this.data=this.data.map((function(t,n){return t.map((function(t,r){return r===n?i||1:e||0}))}))}},{key:"transpose",value:function(){var i=this,e=new t(this.cols,this.rows);return e.data=e.data.map((function(t,e){return t.map((function(t,n){return i.data[n][e]}))})),e}},{key:"invert",value:function(){this.data=this.data.map((function(t){return t.map((function(t){return-1*t}))}))}},{key:"add",value:function(i){i instanceof t?this.data=this.data.map((function(t,e){return t.map((function(t,n){return t+(i.data[e][n]||0)}))})):"number"==typeof i?this.data=this.data.map((function(t){return t.map((function(t){return t+(i||0)}))})):console.log(t.wrong_type_error_message())}},{key:"sub",value:function(i){i instanceof t?this.data=this.data.map((function(t,e){return t.map((function(t,n){return t-(i.data[e][n]||0)}))})):"number"==typeof i?this.data=this.data.map((function(t){return t.map((function(t){return t-(i||0)}))})):console.log(t.wrong_type_error_message())}},{key:"mult",value:function(i){i instanceof t?this.data=this.data.map((function(t,e){return t.map((function(t,n){return t*(i.data[e][n]||1)}))})):"number"==typeof i?this.data=this.data.map((function(t){return t.map((function(t){return t*(i||1)}))})):console.log(t.wrong_type_error_message())}},{key:"div",value:function(i){i instanceof t?this.data=this.data.map((function(t,e){return t.map((function(t,n){return t/(i.data[e][n]||1)}))})):"number"==typeof i?this.data=this.data.map((function(t){return t.map((function(t){return t/(i||1)}))})):console.log(t.wrong_type_error_message())}}],[{key:"Error_Message",value:function(){l=!l,console.log(l?"Error messages are now displayed!":"Error messages are now hidden!")}},{key:"randomInt",value:function(t,i){return Math.floor(t+Math.random()*(i+1-t))}},{key:"array_mult",value:function(i,e){if(!(i instanceof Array&&e instanceof Array&&i.length==e.length))return console.log(t.wrong_type_error_message4()),null;var n=0;return i.forEach((function(t,i){n+=t*e[i]})),n}},{key:"fromArray",value:function(i){if(!(i instanceof Array))return console.log(t.wrong_type_error_message4()),null;i[0]instanceof Array||(i=i.map((function(t){return new Array(1).fill(t)})));var e=1;if(i[0]instanceof Array){if(!i.every((function(t){return t.length==i[0].length})))return console.log(t.wrong_array_dim_error_message()),null;e=i[0].length}var n=new t(i.length,e);return n.data=n.data.map((function(t,e){return i[e]})),n}},{key:"diagonal",value:function(i,e,n){if(!(i instanceof t))throw h;var r=i.copy();return r.diagonal(e,n),r}},{key:"random",value:function(i,e,n){if(!(i instanceof t))throw h;var r=i.copy();return r.random(e,n),r}},{key:"map",value:function(i,e){if(!(i instanceof t))throw h;var n=i.copy();return n.map(e),n}},{key:"add",value:function(t,i){var e=t.copy();return e.add(i),e}},{key:"sub",value:function(t,i){var e=t.copy();return e.sub(i),e}},{key:"mult",value:function(t,i){var e=t.copy();return e.mult(i),e}},{key:"div",value:function(t,i){var e=t.copy();return e.div(i),e}},{key:"prod",value:function(i,e){if(!(i instanceof t&&e instanceof t))return console.log(t.wrong_type_error_message2()),null;if(i.cols!=e.rows)return console.log(t.wrong_dim_error_message()),null;var n=new t(i.rows,e.cols),r=e.transpose();return n.data=n.data.map((function(e,n){return e.map((function(e,o){return t.array_mult(i.data[n],r.data[o])}))})),n}},{key:"invert",value:function(i){if(!(i instanceof t))return console.log(t.wrong_type_error_message2()),null;var e=i.copy();return e.invert(),e}},{key:"deserialize",value:function(i){"string"==typeof i&&(i=JSON.parse(i));var e=new t(i.rows,i.cols);return e.data=i.data,e}}]),t}()),p=function(){this.mass=0,this.d=0,this.gx=0,this.gy=0,this.cgx=[0,0,0,0,0,0],this.cgy=[0,0,0,0,0,0],this.velocity=u.Zero.copy(),this.velocity2=u.Zero.copy(),this.acceleration=u.Zero.copy(),this.particleDensity=0},f=new p,d=function(t,i,e,n,r){this.position=new u(t,i),this.prevPosition=new u(t,i),this.velocity=new u(e,n),this.gridVelocity=this.velocity.copy(),this.material=r,this.cellX=0,this.cellY=0,this.px=[0,0,0],this.py=[0,0,0],this.gx=[0,0,0],this.gy=[0,0,0],this.s=[0,0,0,0,0,0,0,0,0],this.sx=[0,0,0,0,0,0,0,0,0],this.sy=[0,0,0,0,0,0,0,0,0],this.node=[f,f,f,f,f,f,f,f,f],this.T00=0,this.T01=0,this.T11=0,this.affineMomentum=new y(2,2,0)};d.prototype.toJSON=function(){var t={position:Object.assign({},this.position),velocity:Object.assign({},this.velocity),material:this.material};return Object.assign({},t)},d.fromJSON=function(t){var i=t;return new d(i.position.x,i.position.y,i.velocity.x,i.velocity.y,i.material)};var g=d,x=function(t,i,e){this.position=new u(t,i),this.radius=e};x.prototype.toJSON=function(){var t={position:this.position,radius:this.radius};return Object.assign({},t)},x.fromJSON=function(t){return new x(t.position.x,t.position.y,t.radius)};var v=x,m=e(0),w=e.n(m),M=function(t,i){this.Min=t||u.Zero.copy(),this.Max=i||u.Zero.copy(),this.Validity=void 0===t};M.prototype.clear=function(){this.Min.set(u.Zero),this.Max.set(u.Zero),this.Validity=!0},M.prototype.expandToInclude=function(t){0==this.Validity?(t.x<this.Min.x?this.Min.x=t.x:t.x>this.Max.x&&(this.Max.x=t.x),t.y<this.Min.y?this.Min.y=t.y:t.y>this.Max.y&&(this.Max.y=t.y)):(this.Min.set(t),this.Max.set(t),this.Validity=!1)},M.prototype.contains=function(t){return 1!=this.Validity&&(t.x>=this.Min.x&&t.x<=this.Max.x&&t.y>=this.Min.y&&t.y<=this.Max.y)},M.prototype.containsAABB=function(t){return 1!=this.Validity&&(1!=t.Validity&&(t.Min.x>=this.Min.x&&t.Max.x<=this.Max.x&&t.Min.y>=this.Min.y&&t.Max.y<=this.Max.y))},M.prototype.intersects=function(t){var i=this.Min.x<=t.Max.x&&this.Max.x>=t.Min.x,e=this.Min.y<=t.Max.y&&this.Max.y>=t.Min.y;return i&&e},M.prototype.getSize=function(){return this.Max.sub(this.Min)},M.prototype.getMiddle=function(){return this.Min.add(this.Max.sub(this.Min).mulFloat(.5))},M.prototype.getTopLeft=function(){return this.Min},M.prototype.getTopRight=function(){return new u(this.Max.x,this.Min.y)},M.prototype.getBottomLeft=function(){return new u(this.Min.x,this.Max.y)},M.prototype.getBottomRight=function(){return this.Max},M.prototype.subdivide=function(){var t=this.Min,i=this.getMiddle(),e=this.Max;new M(t,i);return[new M(t,i),new M(new u(i.x,t.y),new u(e.x,i.y)),new M(new u(t.x,i.y),new u(i.x,e.y)),new M(i,e)]};var b=M,S=function(t){t=t||{},this.arr=t.arr?t.arr:[],this.activeCount=t.activeCount?t.activeCount:0,this.gsizeY=t.gsizeY?t.gsizeY:0,this.boundaries=t.boundaries?new b(new u(t.boundaries.Min.x,t.boundaries.Min.y),new u(t.boundaries.Max.x,t.boundaries.Max.y)):new b,this.cellSize=t.cellSize?t.cellSize:u.One.copy()};S.prototype.update=function(t){this.recalculateBoundaries(t),this.clear(),this.recalculateSizeY()},S.prototype.clear=function(){this.arr.length=0,this.activeCount=0},S.prototype.iterate=function(t,i){for(var e=this.arr.length,n=0;n<e;n++){var r=this.arr[n];r&&t.call(i,r)}},S.prototype.getAt=function(t,i){return this.arr[t*this.gsizeY+i]},S.prototype.getOrCreateAt=function(t,i){var e=t*this.gsizeY+i,n=this.arr[e];return void 0===n&&(this.arr[e]=n=new p,this.activeCount++),n},S.prototype.recalculateBoundaries=function(t){var i=this;this.boundaries.clear(),w()(t.particles,(function(t){i.boundaries.expandToInclude(t.position)})),this.boundaries.Min.x=Math.floor(this.boundaries.Min.x-1),this.boundaries.Min.y=Math.floor(this.boundaries.Min.y-1),this.boundaries.Max.x=Math.floor(this.boundaries.Max.x+3),this.boundaries.Max.y=Math.floor(this.boundaries.Max.y+3)},S.prototype.recalculateSizeY=function(){this.gsizeY=Math.floor(this.boundaries.Max.y-this.boundaries.Min.y)},S.prototype.toJSON=function(){return Object.assign({},{})},S.fromJSON=function(t){return new S};var _=S,T=function(){function t(i){r()(this,t),this.grid=i}return s()(t,[{key:"updateStateAndGradientOf",value:function(t){var i=t;i.cellX=Math.floor(i.position.x-this.grid.boundaries.Min.x-.5),i.cellY=Math.floor(i.position.y-this.grid.boundaries.Min.y-.5);var e=i.cellX-(i.position.x-this.grid.boundaries.Min.x);i.px[0]=.5*e*e+1.5*e+1.125,i.gx[0]=1.5+e++,i.px[1]=-e*e+.75,i.gx[1]=-2*e++,i.px[2]=.5*e*e-1.5*e+1.125,i.gx[2]=e-1.5;var n=i.cellY-(i.position.y-this.grid.boundaries.Min.y);i.py[0]=.5*n*n+1.5*n+1.125,i.gy[0]=1.5+n++,i.py[1]=-n*n+.75,i.gy[1]=-2*n++,i.py[2]=.5*n*n-1.5*n+1.125,i.gy[2]=n-1.5,i.s[0]=i.px[1]*i.py[1],i.s[1]=i.px[2]*i.py[1],i.s[2]=i.px[2]*i.py[2],i.s[3]=i.px[1]*i.py[2],i.s[4]=i.px[0]*i.py[2],i.s[5]=i.px[0]*i.py[1],i.s[6]=i.px[0]*i.py[0],i.s[7]=i.px[1]*i.py[0],i.s[8]=i.px[2]*i.py[0],i.sx[0]=i.gx[1]*i.py[1],i.sx[1]=i.gx[2]*i.py[1],i.sx[2]=i.gx[2]*i.py[2],i.sx[3]=i.gx[1]*i.py[2],i.sx[4]=i.gx[0]*i.py[2],i.sx[5]=i.gx[0]*i.py[1],i.sx[6]=i.gx[0]*i.py[0],i.sx[7]=i.gx[1]*i.py[0],i.sx[8]=i.gx[2]*i.py[0],i.sy[0]=i.px[1]*i.gy[1],i.sy[1]=i.px[2]*i.gy[1],i.sy[2]=i.px[2]*i.gy[2],i.sy[3]=i.px[1]*i.gy[2],i.sy[4]=i.px[0]*i.gy[2],i.sy[5]=i.px[0]*i.gy[1],i.sy[6]=i.px[0]*i.gy[0],i.sy[7]=i.px[1]*i.gy[0],i.sy[8]=i.px[2]*i.gy[0]}},{key:"prepareParticle",value:function(t){t.node[0]=this.grid.getOrCreateAt(t.cellX+1,t.cellY+1),t.node[1]=this.grid.getOrCreateAt(t.cellX+2,t.cellY+1),t.node[2]=this.grid.getOrCreateAt(t.cellX+2,t.cellY+2),t.node[3]=this.grid.getOrCreateAt(t.cellX+1,t.cellY+2),t.node[4]=this.grid.getOrCreateAt(t.cellX,t.cellY+2),t.node[5]=this.grid.getOrCreateAt(t.cellX,t.cellY+1),t.node[6]=this.grid.getOrCreateAt(t.cellX,t.cellY),t.node[7]=this.grid.getOrCreateAt(t.cellX+1,t.cellY),t.node[8]=this.grid.getOrCreateAt(t.cellX+2,t.cellY)}},{key:"integrate",value:function(t,i){for(var e=0;e<9;e++)i.call(void 0,t,t.node[e],t.s[e],t.sx[e],t.sy[e])}}]),t}(),A=function(t){t=t||{},this.wall=t.wall?t.wall:new b(new u(-50,2),new u(50,100)),this.gravity=t.gravity?t.gravity:new u(0,-.05),this.materials=t.materials?t.materials:[],this.particles=t.particles?t.particles:[],this.springs=t.springs?t.springs:[],this.grid=t.grid?_.fromJSON(t.grid):new _,this.integrator=new T(this.grid),this.implementationType="surfaceTension",this.drawGrid=!1,this.doObstacles=!!t.doObstacles&&t.doObstacles,this.obstacles=t.obstacles?t.obstacles:[],this.doSprings=!!t.doSprings&&t.doSprings,this.drawSprings=!!t.drawSprings&&t.drawSprings};A.prototype.getNumberOfParticles=function(){return this.particles.length},A.prototype.getNumberOfMaterials=function(){return this.materials.length},A.prototype.createNewMaterial=function(){var t=new a(this.materials.length);return this.materials.push(t),t},A.prototype.addParticle=function(t){this.particles.push(t)},A.prototype.update=function(){this.grid.update(this),"surfaceTension"===this.implementationType?this.surfaceTensionImplementation():"mls"===this.implementationType?this.mlsSimulation():this.simpleSimulation()},A.prototype.surfaceTensionImplementation=function(){var t=this;this.mapPropertiesToGrid(),this.sumUpPerMaterialGradients(),w()(this.particles,(function(i,e){var n=i.material,r=0,o=0,s=0,a=0,c=0,l=0;t.integrator.integrate(i,(function(t,i,e,u,h){c+=e*i.cgx[n.materialIndex],l+=e*i.cgy[n.materialIndex],r+=i.velocity.x*u,o+=i.velocity.x*h,s+=i.velocity.y*u,a+=i.velocity.y*h}));var h=Math.floor(i.position.x-t.grid.boundaries.Min.x),y=Math.floor(i.position.y-t.grid.boundaries.Min.y),p=t.grid.getOrCreateAt(h,y),f=t.grid.getOrCreateAt(h,y+1),d=t.grid.getOrCreateAt(h+1,y),g=t.grid.getOrCreateAt(h+1,y+1),x=t.uscip(p.particleDensity,p.gx,p.gy,f.particleDensity,f.gx,f.gy,d.particleDensity,d.gx,d.gy,g.particleDensity,g.gx,g.gy,i.position.x-t.grid.boundaries.Min.x-h,i.position.y-t.grid.boundaries.Min.y-y),v=n.restDensity,m=n.stiffness*(x-v)/v;m>2&&(m=2);var M=o-s,b=.5*M*(i.T01+i.T01),S=.5*M*(i.T00-i.T11),_=r,T=.5*(o+s),A=a,O=.5*(_+A);i.T00+=.5*(_-O-b-n.meltRate*i.T00),i.T01+=.5*(S+T-n.meltRate*i.T01),i.T11+=.5*(b+(A-O)-n.meltRate*i.T11),i.T00*i.T00+2*i.T01*i.T01+i.T11*i.T11>n.maxDeformation&&(i.T00=i.T01=i.T11=0);var k=n.particleMass*(n.elasticity*i.T00+n.viscosity*_+m+O*n.bulkViscosity),P=n.particleMass*(n.elasticity*i.T01+n.viscosity*T),j=n.particleMass*(n.elasticity*i.T11+n.viscosity*A+m+O*n.bulkViscosity),V=c*c+l*l;if(V>0){var C=Math.sqrt(V),E=n.particleMass*n.surfaceTension/C;k-=E*(.5*V-c*c),P-=E*(-c*l),j-=E*(.5*V-l*l)}var F=u.Zero.copy();i.position.x<t.wall.Min.x&&(F.x+=t.wall.Min.x-i.position.x,i.velocity.x*=.1),i.position.x>t.wall.Max.x&&(F.x+=t.wall.Max.x-i.position.x,i.velocity.x*=.1),i.position.y<t.wall.Min.y&&(F.y+=t.wall.Min.y-i.position.y,i.velocity.y*=.1),i.position.y>t.wall.Max.y&&(F.y+=t.wall.Max.y-i.position.y,i.velocity.y*=.1),t.doObstacles&&w()(t.obstacles,(function(t){var e=t.radius,n=e*e,r=t.position.sub(i.position),o=r.lengthSquared();if(o<n){var s=Math.sqrt(o),a=e-s;F.subSelf(r.mulFloat(a/s))}})),t.integrator.integrate(i,(function(t,i,e,n,r){i.acceleration.x+=-(n*k+r*P)+F.x*e,i.acceleration.y+=-(n*P+r*j)+F.y*e}))})),this.grid.iterate((function(t){t.mass>0&&t.acceleration.divFloatSelf(t.mass)}),this),w()(this.particles,(function(i,e){var n=i.material;t.integrator.integrate(i,(function(t,i,e,n,r){t.velocity.weightedAddSelf(i.acceleration,e)})),i.velocity.addSelf(t.gravity),i.velocity.mulFloatSelf(1-n.damping),t.integrator.integrate(i,(function(t,i,e,r,o){i.velocity2.weightedAddSelf(t.velocity,n.particleMass*e)}))})),this.grid.iterate((function(t){t.mass>0&&t.velocity2.divFloatSelf(t.mass)}),this),this.advanceParticles(),this.springDisplacement(),this.boundaryCorrection()},A.prototype.mapPropertiesToGrid=function(){var t=this;w()(this.particles,(function(i,e){var n=i.material;t.integrator.updateStateAndGradientOf(i),t.integrator.prepareParticle(i),t.integrator.integrate(i,(function(t,i,e,r,o){i.mass+=e*n.particleMass,i.particleDensity+=e,i.velocity.weightedAddSelf(t.velocity,n.particleMass*e),i.cgx[n.materialIndex]+=r,i.cgy[n.materialIndex]+=o}))}))},A.prototype.sumUpPerMaterialGradients=function(){var t=this.getNumberOfMaterials();this.grid.iterate((function(i){if(i.mass>0){i.acceleration.clear(),i.gx=0,i.gy=0,i.velocity.divFloatSelf(i.mass);for(var e=0;e<t;e++)i.gx+=i.cgx[e],i.gy+=i.cgy[e];for(e=0;e<t;e++)i.cgx[e]-=i.gx-i.cgx[e],i.cgy[e]-=i.gy-i.cgy[e]}}),this)},A.prototype.uscip=function(t,i,e,n,r,o,s,a,c,u,l,h,y,p){var f=i-r,d=e-c,g=n-t,x=u-s-g,v=s-t,m=h-o;return((((m-2*x-d)*y-2*g+e+o)*p+((3*x+2*d-m)*y+3*g-2*e-o))*p+((((2*v-i-a)*y+(3*x+2*f+a-l))*y-x-d-f)*y+e))*p+(((l-2*(u-n+v)+a+i+r)*y+(3*v-2*i-a))*y+i)*y+t},A.prototype.advanceParticles=function(){var t=this;w()(this.particles,(function(i,e){var n=i.material,r=u.Zero.copy(),o=0,s=0,a=0,c=0;t.integrator.integrate(i,(function(t,i,e,n,u){r.weightedAddSelf(i.velocity2,e),o+=i.velocity2.x*n,s+=i.velocity2.x*u,a+=i.velocity2.y*n,c+=i.velocity2.y*u}));var l=s-a,h=.5*l*(i.T01+i.T01),y=.5*l*(i.T00-i.T11),p=o,f=.5*(s+a),d=c,g=.5*(p+d);i.T00+=.5*(p-g-h-n.meltRate*i.T00),i.T01+=.5*(y+f-n.meltRate*i.T01),i.T11+=.5*(h+(d-g)-n.meltRate*i.T11),i.T00*i.T00+2*i.T01*i.T01+i.T11*i.T11>n.maxDeformation&&(i.T00=i.T01=i.T11=0),i.prevPosition.set(i.position),i.position.addSelf(r),i.gridVelocity.set(r),i.velocity.weightedAddSelf(r.sub(i.velocity),n.smoothing)}))},A.prototype.springDisplacement=function(){this.doSprings&&w()(this.springs,(function(t,i){t.update(),t.solve()}))},A.prototype.boundaryCorrection=function(){var t=this;w()(this.particles,(function(i,e){i.position.x<t.wall.Min.x-4?i.position.x=t.wall.Min.x-4+.01*Math.random():i.position.x>t.wall.Max.x+4&&(i.position.x=t.wall.Max.x+4-.01*Math.random()),i.position.y<t.wall.Min.y-4?i.position.y=t.wall.Min.y-4+.01*Math.random():i.position.y>t.wall.Max.y+4&&(i.position.y=t.wall.Max.y+4-.01*Math.random())}))},A.prototype.toJSON=function(){var t={materials:this.materials,particles:this.particles.map((function(t){return t.toJSON()})),useSurfaceTensionImplementation:this.useSurfaceTensionImplementation,drawGrid:this.drawGrid,doObstacles:this.doObstacles,obstacles:this.obstacles.map((function(t){return t.toJSON()})),doSprings:this.doSprings,drawSprings:this.drawSprings};return Object.assign({},t)},A.fromJSON=function(t){var i=new A(t);return i.materials=t.materials,i.particles=t.particles.map((function(t){return g.fromJSON(t)})),i.obstacles=t.obstacles.map((function(t){return v.fromJSON(t)})),i};var O=A,k=function(t,i,e){this.particle1=t,this.particle2=i,this.restLength=e,this.currentDistance=0};k.prototype.update=function(){this.currentDistance=this.particle1.position.distance(this.particle2.position)},k.prototype.solve=function(){var t=this.particle2.position,i=this.particle1.position,e=t.sub(i);e.mulFloatSelf(1/this.currentDistance);var n=this.particle1.material.springK*(this.restLength-this.currentDistance);e.mulFloatSelf(.5*n),i.subSelf(e),t.addSelf(e)},k.prototype.contains=function(t){return this.particle1===t||this.particle2===t};var P=k,j=function(t,i,e,n,r,o,s,a){this.material=a;for(var c=[],u=i;u<n;u++){c[c.length]=[];for(var l=e;l<r;l++){var h=new g(u,l,o,s,a);t.addParticle(h),a.isElastic&&c[c.length-1].push(h)}}if(a.isElastic){for(u=0;u<c.length;u++)for(l=1;l<c[0].length;l++)t.springs.push(new P(c[u][l-1],c[u][l],c[u][l-1].position.distance(c[u][l].position)));for(l=0;l<c[0].length;l++)for(u=1;u<c.length;u++)t.springs.push(new P(c[u-1][l],c[u][l],c[u-1][l].position.distance(c[u][l].position)));for(u=1;u<c.length;u++)for(l=1;l<c[0].length;l++)t.springs.push(new P(c[u-1][l-1],c[u][l],c[u-1][l-1].position.distance(c[u][l].position)));for(u=0;u<c.length-1;u++)for(l=1;l<c[0].length;l++)t.springs.push(new P(c[u+1][l-1],c[u][l],c[u+1][l-1].position.distance(c[u][l].position)))}};O.prototype.simpleSimulation=function(){this.__calculateParticleKernels(),this.__sumParticleDensityFromGridAndAddPressureansElasticForcesToGrid(),this.__divideGridAccelerationByMass(),this.__accelerateParticlesAndInterpolateVelocityBackToGrid(),this.__divideGridVelocityByMass(),this.__advanceParticles()},O.prototype.__calculateParticleKernels=function(){var t=this;w()(this.particles,(function(i,e){t.integrator.updateStateAndGradientOf(i),t.integrator.prepareParticle(i),t.integrator.integrate(i,(function(t,i,e,n,r){i.mass+=e}))}))},O.prototype.__sumParticleDensityFromGridAndAddPressureansElasticForcesToGrid=function(){var t=this;w()(this.particles,(function(i,e){var n=0;t.integrator.integrate(i,(function(t,i,e,r,o){n+=e*i.mass}));var r=i.material.restDensity,o=(n-r)/r;o>4&&(o=4);var s=u.Zero.copy();i.position.x<t.wall.Min.x&&(s.x+=t.wall.Min.x-i.position.x,i.velocity.x*=.1),i.position.x>t.wall.Max.x&&(s.x+=t.wall.Max.x-i.position.x,i.velocity.x*=.1),i.position.y<t.wall.Min.y&&(s.y+=t.wall.Min.y-i.position.y,i.velocity.y*=.1),i.position.y>t.wall.Max.y&&(s.y+=t.wall.Max.y-i.position.y,i.velocity.y*=.1),t.integrator.integrate(i,(function(t,i,e,n,r){i.acceleration.x+=-n*o+s.x*e,i.acceleration.y+=-r*o+s.y*e}))}))},O.prototype.__divideGridAccelerationByMass=function(){this.grid.iterate((function(t){t.mass>0&&(t.acceleration.divFloatSelf(t.mass),t.acceleration.addSelf(this.gravity))}),this)},O.prototype.__accelerateParticlesAndInterpolateVelocityBackToGrid=function(){var t=this;w()(this.particles,(function(i,e){t.integrator.integrate(i,(function(t,i,e,n,r){t.velocity.weightedAddSelf(i.acceleration,e)})),t.integrator.integrate(i,(function(t,i,e,n,r){i.velocity.weightedAddSelf(t.velocity,e)}))}))},O.prototype.__divideGridVelocityByMass=function(){this.grid.iterate((function(t){t.mass>0&&t.velocity.divFloatSelf(t.mass)}),this)},O.prototype.__advanceParticles=function(){var t=this;w()(this.particles,(function(i,e){i.gridVelocity.clear(),t.integrator.integrate(i,(function(t,i,e,n,r){t.gridVelocity.weightedAddSelf(i.velocity,e)})),i.position.addSelf(i.gridVelocity),i.velocity.weightedAddSelf(i.gridVelocity.sub(i.velocity),i.material.smoothing)}))},O.prototype.mlsSimulation=function(){this.__particleToGrid(),this.__gridVelocityUpdate(),this.__gridToParticle(),this.boundaryCorrection()},O.prototype.__particleToGrid=function(){var t=this;w()(this.particles,(function(i,e){t.integrator.updateStateAndGradientOf(i),t.integrator.prepareParticle(i),t.integrator.integrate(i,(function(t,e,n,r,o){var s=y.fromArray([r,o]),a=u.fromMatrix(y.mult(s,t.affineMomentum)),c=n*t.material.particleMass;e.mass+=c,e.velocity.weightedAddSelf(i.velocity.add(a),c)}))}))},O.prototype.__gridVelocityUpdate=function(){this.grid.iterate((function(t){t.velocity.divFloatSelf(t.mass),t.velocity.addSelf(this.gravity)}),this)},O.prototype.__gridToParticle=function(){var t=this;w()(this.particles,(function(i,e){i.velocity.clear();var n=new y(2,2,0);t.integrator.integrate(i,(function(t,i,e,r,o){var s=new u(i.velocity.x*e,i.velocity.y*e),a=y.fromArray([[s.x*r,s.y*r],[s.x*o,s.y*o]]);n.add(a),t.velocity.addSelf(s)})),i.C=n.mult(4),i.position.addSelf(i.velocity)}))};var V=function(){};V.Material=a,V.Particle=g,V.Group=j,V.Node=p,V.Spring=P,V.Obstacle=v,V.System=O;i.default=V}])}));